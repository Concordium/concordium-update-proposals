<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Protocol Update 8 - Suspension of inactive validators" href="P8.html" /><link rel="prev" title="Protocol Update 6 - Concordium BFT consensus protocol, changes in Wasm validation and execution" href="P6.html" />

    <link rel="shortcut icon" href="../_static/concordium-logo-no-text.svg"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Protocol Update 7 - Smart contract costs and new queries, stake cooldown changes, disabling shielded transfers, revised block hashing - Interoperability Specifications</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=8806b39e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Interoperability Specifications</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/concordium-logo-black.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/concordium-logo-white.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Interoperability Specifications</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Protocol Updates</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="P2.html">Protocol Update 2 - Alpha Centauri 2.0 - Transaction Memos</a></li>
<li class="toctree-l1"><a class="reference internal" href="P3.html">Protocol Update 3 - Alpha Centauri 3.0 - Account Aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="P4.html">Protocol Update 4 - Sirius - Delegation and new contract state</a></li>
<li class="toctree-l1"><a class="reference internal" href="P5.html">Protocol Update 5 - Smart contract upgradability, performance improvements</a></li>
<li class="toctree-l1"><a class="reference internal" href="P6.html">Protocol Update 6 - Concordium BFT consensus protocol, changes in Wasm validation and execution</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Protocol Update 7 - Smart contract costs and new queries, stake cooldown changes, disabling shielded transfers, revised block hashing</a></li>
<li class="toctree-l1"><a class="reference internal" href="P8.html">Protocol Update 8 - Suspension of inactive validators</a></li>
<li class="toctree-l1"><a class="reference internal" href="P9.html">Protocol Update 9 - Protocol-Level Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="P10.html">Protocol Update 9 - Protocol-Level Tokens</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Standards</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-0.html">CIS-0: Standard Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-1.html">CIS-1: Concordium Token Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-2.html">CIS-2: Concordium Token Standard 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-3.html">CIS-3: Sponsored Transaction Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-4.html">CIS-4: Credential Registry Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-5.html">CIS-5: Smart Contract Wallet Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-6.html">CIS-6: Track-and-Trace Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-7.html">CIS-7: Protocol-level Tokens (PLTs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ID/concordium-did.html">Concordium DID Method Version 1.0</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/updates/P7.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="protocol-update-7-smart-contract-costs-and-new-queries-stake-cooldown-changes-disabling-shielded-transfers-revised-block-hashing">
<h1>Protocol Update 7 - Smart contract costs and new queries, stake cooldown changes, disabling shielded transfers, revised block hashing<a class="headerlink" href="#protocol-update-7-smart-contract-costs-and-new-queries-stake-cooldown-changes-disabling-shielded-transfers-revised-block-hashing" title="Link to this heading">¶</a></h1>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><th class="stub"><p>Effective on Testnet</p></th>
<td><p>Sep 30, 2024</p></td>
</tr>
<tr class="row-even"><th class="stub"><p>Effective on Mainnet</p></th>
<td><p>Oct 30, 2024</p></td>
</tr>
<tr class="row-odd"><th class="stub"><p>Specification hash</p></th>
<td><p><code class="docutils literal notranslate"><span class="pre">e68ea0b16bbadfa5e5da768ed9afe0880bd572e29337fe6fb584f293ed7699d6</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<section id="specification">
<h2>Specification<a class="headerlink" href="#specification" title="Link to this heading">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                           Protocol update

Protocol Version: 7
Builds on Protocol Version: 6

                               Abstract

This document describes the changes in Concordium protocol version 7 compared to
protocol version 6.

The protocol change has the following main effects
- redefines smart contract costs, reducing the cost of smart contract calls;
- adds support for querying the module reference and contract name of a smart
  contract instance in smart contracts;
- changes cooldown behavior so that:
   * when validators and delegators reduce their stake, the reduction is
     immediately effective for future stake calculations, and the amount of the
     reduction is locked for a cooldown period;
   * validators and delegators can make further changes to their stake while
     they already have stake in cooldown;
- disallows shielded (or encrypted) transfer transactions (`TransferToEncrypted`, 
  `EncryptedAmountTransfer` and `EncryptedAmountTransferWithMemo`).
- redefines the block hashing scheme to better support light clients.

                              Background

Smart contract execution costs are reduced in protocol version 7 because of
efficiency improvements in the implementation of smart contract execution.
The revised cost model is based on an execution model where the interpreter
stack is compiled to registers.

The new protocol version also imposes a limit on the nesting depth of
inter-contract calls to 384. This is since each live execution frame can
require up to 32MB of memory, so limiting the number of active execution
frames in this way safeguards against excessive memory use.

                                * * *

As of protocol version 7, smart contracts are able to query the module
reference and contract name of a smart contract instance. This can be used
to identify the code that is behind a smart contract instance, for example as
a means of authenticating a smart contract before interacting with it. A
particular motivation for this is to implement a factory pattern, where one
smart contract (the factory) is responsible for initializing instances of
another (the product). On Concordium, one smart contract cannot directly
create instances of another, but it can be used to invoke an initialization
method on another. The additional queries allow the factory to ensure that
the contract instance it is initializing is of the correct type.

                                * * *

Prior to protocol version 7, when a validator or a delegator reduces or
removes its stake, the amount of the stake reduction is held in a cooldown
state. During the cooldown period, the stake cannot be spent, and remains
part of the effective stake (used for lottery and reward calculation). Once
the cooldown period has elapsed, the stake is available to be spent, and
no longer contributes to the effective stake of the validator or delegator.
While the cooldown is in effect on an account, no other changes can be made
to the account&#39;s stake.

From protocol version 7, when a validator or delegator reduces its stake,
the stake reduction takes effect straight away, but the amount of the
reduction enters a cooldown queue. (Note that &quot;straight away&quot; here does
not mean that it has an instant effect on the lottery and rewards. The
effective stakes of validators and delegators are sampled in the first block
of the last epoch before each payday, with the sampled stakes being used
for the upcoming payday. Although the change is recorded on the account
immediately, it will be between 1 epoch and 1 payday plus 1 epoch until
the change affects the proof-of-stake lottery used for consensus.)
Stake in the cooldown queue is considered to be inactive stake, and, as
such, does not contribute to the lottery calculation. However, the
inactive stake still cannot be spent, although it is possible to transfer
it back to active stake.

When stake is removed from a validator or delegator, it enters cooldown
at the point that the removed stake is no longer part of the effective
stake for lottery calculations. Specifically, when the stake is removed,
it first enters a &quot;pre-pre-cooldown&quot; state. When the stake snapshot is
taken for the next payday (in the first block of the epoch before the payday)
it is moved from &quot;pre-pre-cooldown&quot; to &quot;pre-cooldown&quot;. At the subsequent
payday, it is moved from &quot;pre-cooldown&quot; into &quot;cooldown&quot;, and the cooldown
expiry time is set based on the cooldown time chain parameter. In
particular, the cooldown officially starts at this payday. At the first
payday at or after the cooldown expiry time, the stake finally exits
&quot;cooldown&quot; and becomes available to spend. An account&#39;s active stake
can be reduced while there is still inactive stake in cooldown, leading
to multiple amounts in cooldown (or pre-cooldown or pre-pre-cooldown)
that expire at different times.

If the active stake on an account is increased, the increase is first
transferred from the inactive stake in preference to taking from the
unstaked balance. Specifically, it is taken first from &quot;pre-pre-cooldown&quot;,
then &quot;pre-cooldown&quot;, and then from the &quot;cooldown&quot; stakes in decreasing
order of expiry time. An account can also switch freely between being
a validator and being a delegator without its stake entering cooldown.
(Prior to protocol version 7, it was necessary to remove the validator
or delegator on an account, waiting out the cooldown period, before
instating a delegator or validator.) As a consequence of this, from
protocol version 7, no distinction is drawn between the cooldown time
for validators and for delegators: stake entering cooldown expires
after the minimum of both times.

The purpose of these changes is to maximise the flexibility of staking,
while ensuring that any stake must still be locked for the cooldown
period before it can be spent.

                                * * *

Since the initial protocol version, the Concordium blockchain has
supported shielded transfers (also known as encrypted transfers).
This mechanism allows an account to &quot;shield&quot; part of its balance, 
cryptographically encrypting it so that the amount cannot be inspected
except by the owner of the account (using its secret encryption key).
(It is possible for a sufficient combination of identity disclosure
authorities (e.g. 2 of 3) to act in concert with the identity provider
for an account to recover the secret encryption key (for instance, if
compelled to do so by legal authorities) and thus decrypt the shielded
balance and transfers on that account.)

An account can transfer an amount from its shielded balance to another
account. While the sender and receiver are publicly visible, the exact
amount transferred (in CCD) is not. An account can also decrypt funds from
its shielded balance, enabling them to be spent as normal. Each of
these operations makes use of zero-knowledge proofs to ensure that
the transfers are carried out correctly (i.e. without creating or
destroying any CCDs) while not revealing the encrypted values.

This feature has not seen widespread use. Moreover, the presence of
shielded transfers is seen as a barrier to adoption of Concordium
by some risk-averse parties. As such, the shielded transfers are
no longer supported as of protocol version 7.

In particular, shielding (or encrypting) a public balance and
transferring shielded funds from one account to another are
disallowed from protocol version 7. Unshielding (i.e., transferring
funds from an account&#39;s shielded funds to its own unshielded funds)
remains enabled. This ensures that accounts do not lose any funds that
they previously shielded.

                                * * *

A block hash is a cryptographic hash of the contents of a block, and serves
as a unique identifier for the block. The block hash is not only derived from
the header fields of a block, but also the state of the chain after executing
the block, including the current state of each account and smart contract.
The block hashing scheme determines how the block hash is derived from this
data. In particular, individual elements are hashed and their hashes are
combined and hashed again into a Merkle tree structure. This structure makes
it possible to prove that a block (whose hash is known to the verifier)
contains some specific data (such as the balance of a particular
account) without providing the entirety of the data comprising the block.

In protocol version 7, the block hashing scheme is redefined. The revised
definition makes certain Merkle proofs shorter and simpler. The purpose of
this is to support &quot;light clients&quot;: light-weight verifiers that can check
properties of the chain without running the full consensus, by making use of
Merkle proofs.

                               Changes

The following behaviors are changed in protocol version 7.

1. The cost metering for smart contract execution is redefined. The new
   instruction costs of WebAssembly instructions are defined below
   (1 Energy = 1000 Interpreter Energy):

   Instruction      Old cost (Interpreter Energy)   New cost (Interpreter Energy)

   nop              1                               1
   unreachable      0                               0
   block            0                               0
   loop             0                               0
   if               10                              4
   br               8 + target arity (0 or 1)       2
   br_if            10                              4
   br_table         10 + target arity               7
   return           8 + return arity                2
   call             26 + #arg + #res                6 + #arg + #res
   call_indirect    28 + 2*(#arg + #res)            8 + floor(1.1*(#arg + #res))
   
   drop             2                               0
   select           3                               2

   local.get        3                               0
   local.set        3                               0
   local.tee        3                               0
   global.get       3                               1
   global.set       3                               1

   inn.load*        4                               1
   i32.store        8                               2
   i64.store        10                              2
   i32.store8       5                               2
   i32.store16      8                               2
   i64.store8       7                               2
   i64.store16      9                               2
   i64.store32      10                              2
   memory.size      4                               1
   memory.grow      10 + 100 * #pages               10 + 100 * #pages

   inn.const        2                               0
   inn.eqz          3                               1
   inn.clz          3                               1
   inn.ctz          3                               1
   inn.popcnt       3                               1
   inn.eq           4                               1
   inn.ne           4                               1
   inn.lt*          4                               1
   inn.gt*          4                               1
   inn.le*          4                               1
   inn.ge*          4                               1
   inn.add          4                               1
   inn.sub          4                               1
   inn.mul          5                               2
   inn.div*         5                               2
   inn.rem*         5                               2
   inn.and          4                               1
   inn.or           4                               1
   inn.xor          4                               1
   inn.shl          4                               1
   inn.shr*         4                               1
   inn.rotl         4                               1
   inn.rotr         4                               1
   i32.wrap_i64     3                               1
   inn.extend*      3                               1

   (Here, target arity and return arity are the arity of the target
   label and the current activation frame respectively; #arg and
   #res are the numbers of arguments and results of the function
   being called; and #pages is the number of memory pages requested
   by memory.grow. &quot;inn&quot; indicates both &quot;i32&quot; and &quot;i64&quot; variants, and
   where instructions are suffixed with *, the line applies to all variants.
   For instance, inn.load* includes i32.load8_s, i64.load8_u, etc.)

   The cost (in Energy) of looking up a contract module is reduced from
   floor(size / 50) to floor(size / 500), where size is the size of the
   module&#39;s WebAssembly source in bytes, not including custom sections.
   This cost is incurred on contract initialization, update, upgrading and
   inter-contract calls.
   
2. The maximum nesting depth of V1 contract calls is limited to 384.

3. In V1 smart contracts, the `invoke` host function allows for two
   additional operations:

   - Query smart contract module reference:
      * Instruction tag: 7
      * Payload:
        - contract index (8 bytes, little endian)
        - contract subindex (8 bytes, little endian)
      * Return codes:
        - 0: success
           the return value is the module reference of the specified
           contract instance
        - 3: missing contract
           there is no contract instance with the given address
      * Cost: 200 Energy
   - Query smart contract name:
      * Instruction tag: 8
      * Payload:
        - contract index (8 bytes, little endian)
        - contract subindex (8 bytes, little endian)
      * Return codes:
        - 0: success
           the return value is the name of the `init` method used to
           create the contract instance (including the &quot;init_&quot; prefix)
        - 3: missing contract
           there is no contract instance with the given address
      * Cost: 200 Energy

4. The following changes apply to staking:
   - The stake of an account is divided into
     * Active stake: this determines the validator or delegator&#39;s
       stake for future snapshots that determine the stake
       distribution for the purposes of lottery calculation and
       reward distribution.
     * Inactive stake: this does not contribute to lottery or
       reward calculations, but is locked for a period of time.
       The inactive stake can consist of multiple amounts that
       can be in the following states:
       - cooldown with a specific expiry time
       - pre-cooldown
       - pre-pre-cooldown
   - When a validator or delegator is removed from an account, the
     validator or delegator record is removed from the account and
     the active stake is moved to the inactive stake in the
     pre-pre-cooldown stake.
   - When a validator or delegator has its stake reduced, the amount
     of the reduction is moved to the inactive stake in the
     pre-pre-cooldown stake.
   - When a validator or delegator has its stake increased (including if
     an account becomes a validator or delegator when it was neither),
     the amount of the increase will be taken preferentially from
     inactive stake in the following order:
     * pre-pre-cooldown
     * pre-cooldown
     * cooldown (starting from the highest expiry timestamp)
   - A validator or delegator may switch to the other role at any time
     (by a `ConfigureBaker` or `ConfigureDelegator` transaction). It is
     only subject to cooldown in this process insofar as the stake is
     reduced.
   - At the first block in an epoch, the following occur:
     * If the epoch is the first of a new payday (a payday epoch) then
       all amounts in cooldown that are set to expire at or before the
       transition time for the previous epoch (the payday time) are
       released from the inactive stake of accounts. All amounts in
       pre-cooldown are moved into cooldown, with the expiry time set
       to be the minimum of the current validator and delegator cooldown
       time parameters (accounting for any parameter changes up to the
       current block) after the payday time.
       [Note: as before, at payday the current epoch stakes and capital
       distribution are updated based on the snapshot taken in the
       previous epoch, and all rewards are paid out that have accrued.]
    * If the epoch is the last before a new payday (a snapshot epoch)
      then all amounts in pre-pre-cooldown are transferred to pre-cooldown.
      [Note: as before, in a snapshot epoch, the snapshot of the stakes
      and capital distribution is taken for the next payday.]

5. The transaction payload types `TransferToEncrypted`,
   `EncryptedAmountTransfer` and `EncryptedAmountTransferWithMemo` are
   considered invalid. Transactions of these types will be rejected with
   a `SerializationFailure` result.

6. The block hashing for a (non-genesis) block in protocol version 7 follows
   the structure below:

   [BlockHash]
   |- protocol version
   |- [...]
      |- [BlockHeaderHash]
      |  |- round
      |  |- epoch
      |  |- [parent BlockHash]
      |
      |- [BlockQuasiHash]
         |- [metaHash]
         |  |- [bakerInfoHash]
         |  |  |- [timestampBakerHash]
         |  |  |  |- timestamp
         |  |  |  |- baker ID
         |  |  |
         |  |  |- [nonceHash]
         |  |     |- block nonce
         |  |
         |  |- [certificatesHash]
         |     |- [QuorumCertificate hash]
         |     |  |- [parent BlockHash]
         |     |  |- QC round
         |     |  |- QC epoch
         |     |  |- aggregate signature
         |     |  |- signatories
         |     |
         |     |- [timeoutFinalizationHash]
         |        |- [Option TimeoutCertificate hash]
         |        |- [Option FinalizationEntry hash]
         |
         |- [dataHash]
            |- [transactions hash]
            |- [BlockResultHash]
               |- [...]
               |  |- [BlockStateHash]
               |  |- [TransactionOutcomesHash]
               |
               |- [...]
                  |- [block height info hash]
                  |  |- absolute block height
                  |  |- genesis index
                  |  |- relative block height
                  |
                  |- [...]
                     |- [current FinalizationCommitteeHash]
                     |- [next FinalizationCommitteeHash]

                               Effects

1. At the protocol update, the following changes apply to validator and
   delegator accounts:
   * If the account was pending cooldown, it is removed from
     the pending state and the amount of the reduction in stake will be moved
     from its active stake to the pre-pre-cooldown inactive stake.
   * If the account was pending removal (of the validator or delegator),
     the validator or delegator record is removed from the account and the
     active stake is moved to the pre-pre-cooldown inactive stake.

2. Behavior of existing V1 contract instances may be affected in the
   following scenarios:
   - The cost of smart contract execution is changed as described above.
   - If the contract execution exceeds a nesting depth of 384 contract
     calls, the execution will fail.
   - If the contract uses the `invoke` operation with tags 7 or 8, prior
     to the update a runtime error would be triggered; after the update
     the behavior will be as defined above (querying the module reference
     or name).
   
                     Protocol update instruction

The protocol update instruction is identified by the SHA256 hash of
this file. There is no auxiliary data for the update instruction.
</pre></div>
</div>
</section>
<section id="commentary">
<h2>Commentary<a class="headerlink" href="#commentary" title="Link to this heading">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                      Protocol update commentary

Protocol Version: 7
Builds on Protocol Version: 6

Protocol version 7 introduces protocol changes in the following key areas:
- smart contract costs
- new smart contract queries
- modified stake cooldown behavior
- removal of shielded transactions
- redefined block hashing

This document provides commentary on each of these changes, elaborating on
the rationale for each.

    1. Smart Contract Costs

The cost of a smart contract transaction (such as a contract init or update)
is a function of the WebAssembly instructions that are executed in computing
the outcome of the transaction. Each instruction is associated with a cost
(measured in &quot;interpreter energy&quot;). When a smart contract module is deployed
on the Concordium blockchain, the nodes apply a transformation on the
WebAssembly code that instruments it with metering instructions, which track
the interpreter energy usage during program execution. A smart contract
transaction (as with other transactions) has an energy limit associated with
it. If the energy usage during execution exceeds this limit, the transaction
will simply fail. The energy used by the transaction is ultimately paid for
by the sender of the transaction in a proportional amount of CCD, and these
fees are used to recompense validators.

The purpose of all of this is to limit the demands that individual
transactions can place on the resources of nodes in the Concordium blockchain,
specifically, execution time. Accordingly, the costs associated with
instructions are intended to be a close proxy for the actual execution time.
The costs are assigned based on benchmarking so that 1,000,000 energy
corresponds to roughly 1 second of execution time. (Note that the actual
execution time cannot be used to determine the cost of smart contract
transactions, since it will vary from node to node and consensus requires
that nodes agree on all details.)

Concordium node version 7 improves smart contract execution by employing a
compilation phase that transforms the stack-machine based WebAssembly into
a register-based intermediate representation. This representation can be
interpreted more efficiently, as operations are performed directly on their
operands, eliminating stack manipulation. The result of this is that
execution times are typically around 3 times faster. Accordingly the cost
of WebAssembly instructions is redefined to reflect this.

When a smart contract makes a call to another smart contract, the calling
contract&#39;s state remains in memory, while the callee&#39;s state is also
loaded. In the case of a long chain of such calls, this can use a lot of
memory, potentially exhausting the resources of nodes. Previously, the
energy limits were deemed sufficient to limit the resource usage. However,
in light of reduced energy costs, it was decided to impose a limit on the
depth of nested inter-contract calls to 384, to guard against resource
exhaustion. Since each live execution frame can be up to 32 MB in size,
this limits the total size of live execution frames to 12 GB. This limit
was chosen given the minimum RAM requirement for a node of 16 GB.

Further reading:
  In the Concordium node implementation, the metering transformation can be
  found at https://github.com/Concordium/concordium-base/blob/main/smart-contracts/wasm-transform/src/metering_transformation.rs
    

    2. New Smart Contract Queries

Protocol version 7 introduces new query operations that are available to
smart contracts. These operations get the module reference and smart
contract name associated with a smart contract instance. This can be used
to check if a smart contract instance is an instance of a particular known
smart contract, for example, or to check if a smart contract has been
upgraded (in which case, its module reference will change). These kind of
checks can be useful when designing smart contracts to interact in a
partial-trust situation: a smart contract can authenticate the other
contracts it interacts with before determining whether to trust them.

A common question from smart contract developers (particularly those
coming from Ethereum) is how to implement a factory pattern on Concordium.
The architecture of Concordium&#39;s contracts (separating module deployment
from contract initialization) means that typically a factory pattern is
not required. However, these new contract inspection operations provide
a way of emulating the factory pattern in the cases where it is needed.
For details, see:
https://developer.concordium.software/en/mainnet/smart-contracts/guides/factory-pattern.html

    3. Stake Cooldown Changes

The changes to stake cooldown have two main effects. First, when validators
and delegators reduce (or remove) stake, the amount of the reduction no
longer contributes to the calculations that determine lottery power and
rewards (after the following payday), but is held in a cooldown state
where it cannot be spent. Second, while stake is in cooldown, further
changes to the stake can be made, such as increasing it, decreasing it
further, removing it, or even changing between validator and delegator.

The first change brings Concordium closer in line with common industry
practice, while also strengthening a buffer against nothing-at-stake
attacks, since a malicious validator cannot sell their stake for a
certain time after they no longer have any effective power in the
proof-of-stake consensus.

The second change gives validators and delegators much more flexibility.
Previously, while stake was in cooldown, the stake could not be changed
(neither up nor down) and it was impossible to transition directly between
being a validator or a delegator. In protocol version 7, both of these
are possible. This change is of particular benefit to custodial staking
providers, who may hold stake for multiple customers on a single (validator)
account. The new arrangement allows them to withdraw funds for different
customers independently. For instance, under the old scheme, if the staking
provider unstaked customer A&#39;s funds, and then wished to also unstake
customer B&#39;s funds, then they would have to wait two full cooldown periods
before B&#39;s funds were unstaked, no matter how soon they requested them after
A&#39;s funds were already being unstaked. In the new scheme, the fact that
A&#39;s funds are in cooldown does nothing to prevent B&#39;s funds also moving to
cooldown.

    4. Removal of Shielded Transactions

Shielded transactions allow accounts to send funds to each other while
obscuring the exact amount of the transfer. Part of the rationale for
supporting such transfers was to enhance the privacy for users, since the
blockchain is an entirely public record.

This feature has not seen wide adoption (at time of writing, less than
200000 CCD is shielded) and has generally been more confusing than
beneficial for users, who may have mistakenly shielded their balances
unnecessarily, without properly understanding the use of shielded transfers.

Furthermore, financial institutions with obligations under
anti-money-laundering laws may be hesitant to adopt Concordium under the
impression that such a feature could possibly enable money laundering.
In fact, the identity disclosure authorities and identity providers can,
if necessary, unmask the shielded transfers on an account, providing a
deterrent against and remedy for any use of shielded transfers for money
laundering.

For these reasons, it was decided to remove shielded transfers, disabling
the ability to shield balances and to transfer shielded amounts. However, as
shielded balances are encrypted, there is no way to simply unshield balances
automatically. Therefore, the ability to unshield balances remains, and
existing shielded balances on accounts will remain.

    5. Redefined Block Hashing

The revision of the block hashing scheme in protocol version 7 is designed
to simplify Merkle proofs of various properties of blocks, such as:

  - The outcome of a particular transaction in a block.
  - Which finalization committee certifies blocks in the next epoch.
  - That the (partial) state of a specific smart contract has a particular
    value.

These proofs support and provide utility for light clients. A light client
knows the current block height and the finalization committees for the current
and next epochs. The client can update its state given a finalization proof
(signed by one of the finalization committees) for a block, and a Merkle
proof that establishes the new block height and finalization committees.

Implementing light clients as smart contracts allows trustless bridging
between suitable blockchains. Such a bridge uses light clients to validate
messages sent between chains, eliminating the need to trust third-party
relayers. Instead, the consensus protocol itself guarantees the integrity
of the messages. A Concordium light client would verify cryptographically
that the finalization committee saw the message being sent from the Concordium
chain. These changes to block hashing are thus a step towards connecting
Concordium to the wider blockchain ecosystem, for instance using the
Inter-Blockchain Communication (IBC) protocol (https://www.ibcprotocol.dev).

The same technology behind light clients can also support lightweight nodes.
Currently, Concordium nodes maintain the entire state history of the
blockchain, which is a significant and ever-growing quantity of data.
(As of writing, this amounts to approximately 115 GB of data for mainnet.)
Moreover, starting a new node from scratch is extremely time-consuming,
since the node executes every one of the millions of blocks in sequence.
A lightweight node would only store the recent state and an abbreviated
summary of historical blocks, sufficient to prove the correctness of the
current state. This would allow for faster node catch-up and reduced
storage requirements.
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="P8.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Protocol Update 8 - Suspension of inactive validators</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="P6.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Protocol Update 6 - Concordium BFT consensus protocol, changes in Wasm validation and execution</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, Concordium
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Protocol Update 7 - Smart contract costs and new queries, stake cooldown changes, disabling shielded transfers, revised block hashing</a><ul>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#commentary">Commentary</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>