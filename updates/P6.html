<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="CIS-0: Standard Detection" href="../CIS/cis-0.html" /><link rel="prev" title="Protocol Update 5 - Smart contract upgradability, performance improvements" href="P5.html" />

    <link rel="shortcut icon" href="../_static/concordium-logo-no-text.svg"/><meta name="generator" content="sphinx-4.2.0, furo 2021.09.08"/>
        <title>Protocol Update 6 - Concordium BFT consensus protocol, changes in Wasm validation and execution - Interoperability Specifications</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=c7c65a82b42f6b978e58466c1e9ef2509836d916" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=16fb25fabf47304eee183a5e9af80b1ba98259b1" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Interoperability Specifications</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/concordium-logo-black.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/concordium-logo-white.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Interoperability Specifications</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Protocol Updates</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="P2.html">Protocol Update 2 - Alpha Centauri 2.0 - Transaction Memos</a></li>
<li class="toctree-l1"><a class="reference internal" href="P3.html">Protocol Update 3 - Alpha Centauri 3.0 - Account Aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="P4.html">Protocol Update 4 - Sirius - Delegation and new contract state</a></li>
<li class="toctree-l1"><a class="reference internal" href="P5.html">Protocol Update 5 - Smart contract upgradability, performance improvements</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Protocol Update 6 - Concordium BFT consensus protocol, changes in Wasm validation and execution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Standards</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-0.html">CIS-0: Standard Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-1.html">CIS-1: Concordium Token Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-2.html">CIS-2: Concordium Token Standard 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-3.html">CIS-3: Sponsored Transaction Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIS/cis-4.html">CIS-4: Credential Registry Standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ID/concordium-did.html">Concordium DID Method Version 1.0</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="protocol-update-6-concordium-bft-consensus-protocol-changes-in-wasm-validation-and-execution">
<h1>Protocol Update 6 - Concordium BFT consensus protocol, changes in Wasm validation and execution<a class="headerlink" href="#protocol-update-6-concordium-bft-consensus-protocol-changes-in-wasm-validation-and-execution" title="Permalink to this headline">¶</a></h1>
<div class="table-wrapper"><table class="docutils align-default">
<colgroup>
<col style="width: 50%"/>
<col style="width: 50%"/>
</colgroup>
<tbody>
<tr class="row-odd"><th class="stub"><p>Effective on Testnet</p></th>
<td><p>Aug 21, 2023</p></td>
</tr>
<tr class="row-even"><th class="stub"><p>Effective on Mainnet</p></th>
<td><p>planned Sep 25, 2023</p></td>
</tr>
<tr class="row-odd"><th class="stub"><p>Specification hash</p></th>
<td><p><code class="docutils literal notranslate"><span class="pre">ede9cf0b2185e9e8657f5c3fd8b6f30cef2f1ef4d9692aa4f6ef6a9fb4a762cd</span></code></p></td>
</tr>
</tbody>
</table></div>
<section id="specification">
<h2>Specification<a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                           Protocol update

Protocol Version: 6
Builds on Protocol Version: 5

                               Abstract

This document describes the changes in Concordium protocol version 6
compared to protocol version 5.

The protocol change has the following main effects
- it changes the consensus protocol from an existing two-layer design
  to a new ConcordiumBFT consensus
- fixes the behavior of state rollbacks in specific scenarios with
  version 1 contracts.
- extends the list of supported Wasm instructions for version 1
  contracts, and fixes an incompatibility with the Wasm standard
- adds better support for sponsored transactions

                              Background

Protocol version 6 changes protocol version 5 in two main areas.
The first area is a relatively modest extension of smart contract
functionality, with the main effect being better support for
sponsored transactions.
The major update in protocol 6 however, is the new consensus protocol,
ConcordiumBFT.

Before this protocol update, the Concordium chain uses a two-layer
consensus protocol following [1]. The first layer is a Nakomoto-style
consensus where "bakers" propose blocks extending the best chain. The
bakers are chosen by a distributed lottery, with their chance of winning
weighted by their effective stake. The lottery takes place at regular
time intervals ("slots") and there can be zero or more winners in any
given slot. At this layer, branching and roll-backs can occur.

The second layer is a Byzantine fault tolerant (BFT) protocol that
recurrently declares blocks as finalized. Finalized blocks cannot be
rolled back. The participants in the finalization protocol (the
"finalization committee", or just "finalizers") are a subset of the
bakers with the highest effective stakes.

In protocol 6, the consensus protocol is replaced with ConcordiumBFT, a
new protocol based on Jolteon [2]. In ConcordiumBFT, bakers are still
selected by lottery to bake blocks. However, the lottery is no longer
attached to time slots, but instead takes place in "rounds". A round
does not correspond to a particular time, but is advanced once the
finalization committee determines which block (if any) is to be
certified in the round.

When the winning baker for a round produces a block, it is distributed.
The finalizers sign the block, sending out their signatures. Once
signatures from 2/3 of the committee (weighted by stake) for the same
block are collected, these form a quorum certificate (QC). This quorum
certificate allows the bakers to advance to the next round. The baker
for the next round includes the QC in its block.

If a QC cannot be produced in a certain amount of time (for instance,
because the baker did not produce a block), then the finalizers instead
sign timeout messages. When 2/3 of the committee agree that the round
has timed out, these messages are aggregated into a timeout certificate
(TC). The timeout certificate allows the round to advance, and a baker can
produce a block for the next round by including a TC for the previous
round, and a QC for an earlier round.

When blocks on a common chain in two consecutive rounds have quorum
certificates, the block in the first of these rounds (together with its
ancestors) is considered finalized. At this point, the protocol ensures
that it cannot be rolled back. The two consecutive blocks must also be
within the same epoch.

Leaders are determined per epoch, and are known to everybody for the epoch.
The notion of a payday, as it exists in protocols 4 and 5, remains largely
unchanged, although payday transitions are slightly changed due to the
technicalities of how epoch transitions occur in ConcordiumBFT.
However in normal conditions there should be little observable effect on
users of the chain.

                               Changes

The following behaviors are changed in protocol version 6.

1. ConcordiumBFT takes effect. In particular this changes the format of
   blocks, and the messages exchanged by the nodes.
2. The election difficulty chain parameter is removed.
3. There are new chain parameters
   - the minimum timeout, and factors for increasing and decreasing round
     timeout duration on successive round timeouts and finalizations,
     respectively
   - minimum block time, controlling the minimum time between blocks in two
     successive rounds
   - minimum number of finalizers and maximum number of finalizers. These,
     together with the existing finalizer relative stake threshold
     parameter, revise the condition on being a finalizer. The relative
     stake threshold is not interpreted relative to the total effective
     stake of bakers. The minimum number of finalizers must be reached
     before the relative stake threshold applies. Analogously, the number
     of finalizers are capped.
4. Block energy limit becomes an updatable parameter.
5. Smart contract validation has the following changes
   - Version 1 smart contracts can now use sign extension Wasm
     instructions (i32.extend8_s, i32.extend16_s, i64.extend8_s,
     i64.extend16_s, i64.extend32_s), see
     https://webassembly.github.io/spec/core/exec/instructions.html
     for their meaning.
   - In version 1 smart contracts, the contract schema, and other custom
     sections, no longer count towards the cost when executing contracts
     for modules that were deployed in protocol 6.
   - The behavior of rollbacks in certain cases of reentrant contract
     calls is corrected to conform to the intended semantics. In protocols
     4 and 5 state changes might not be rolled back in case of failure of
     nested, reentrant contract calls.
6. In V1 smart contracts, the `invoke` operation allows for two additional
   operations, querying account keys, and checking a signature with respect
   to the account keys.

                               Effects

1. The consensus change has no direct effects on the state of accounts and
   contracts. The overall immediate effect of the new consensus will be, in
   normal network conditions, that transaction confirmation times will have
   much less variance.

2. The change of the condition on a baker being a finalizer can result in some
   bakers that were not a finalizer before the protocol update becoming a
   finalizer after, or vice-versa, depending on the update parameters and the
   state of the chain at the time of the update.

3. Behavior of existing V1 contract instances may be affected in the
   following scenarios
   - if the contract attempted to perform an operation with tags (operation
     identifiers) 5 or 6 the execution would have triggered a runtime error. In
     protocol 6 the response can either be a runtime error, or a response code
     indicating the result of the operation, depending on the parameters
     supplied to the operation.
   - if the contract interaction triggered the incorrect rollback behavior
     then the semantics of those contract executions will change.
   - the cost of some smart contract executions may change slightly as a
     result of fixes to address the incorrect behavior of rollbacks.

                     Protocol update instruction

The protocol update instruction is identified by the SHA256 hash of
this file. The instruction needs the following auxiliary data

- minimum round timeout in milliseconds
- timeout increase factor
- timeout decrease factor
- minimum time between blocks in milliseconds
– block energy limit
- finalization relative stake threshold, minimum and maximum number of finalizers

                     References

  [1] Thomas Dinsdale-Young, Bernardo Magri, Christian Matt, Jesper Buus
      Nielsen, and Daniel Tschudi: "Afgjort: A Partially Synchronous
      Finality Layer for Blockchains". Cryptology ePrint Archive, Paper
      2019/504. DOI 10.1007/978-3-030-57990-6_2
      &lt;https://eprint.iacr.org/2019/504&gt;

  [2] Rati Gelashvili, Lefteris Kokoris-Kogias, Alberto Sonnino,
      Alexander Spiegelman, and Zhuolun Xiang: "Jolteon and Ditto:
      Network-Adaptive Efficient Consensus with Asynchronous Fallback".
      arXiv:2106.10362. DOI 10.48550/arXiv.2106.10362
      &lt;https://arxiv.org/abs/2106.10362&gt;
</pre></div>
</div>
</section>
<section id="commentary">
<h2>Commentary<a class="headerlink" href="#commentary" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                      Protocol update commentary

Protocol Version: 6
Builds on Protocol Version: 5

Protocol version 6 changes protocol version 5 in two main areas. The
first area is a relatively modest extension of smart contract
functionality, with the main effect being better support for sponsored
transactions. The major update in protocol 6 however, is the new
consensus protocol, Concordium BFT.

Up to and including protocol 5, Concordium used a two-layer consensus
design, with a proof of stake Nakamoto style consensus at the base
layer with finalization on top which marked certain blocks as finalized.
The idea being that the base Nakamoto layer works as long as more than
1/2 of stake adheres to the protocol over long periods of time, but
the finalization layer ensures speedy, explicit, finalization, in good
conditions when there is more than 2/3 liveness and adherence to protocol.

While this two-layer design did serve Concordium well during the initial
phase, and is in theory robust, the two layer design is rather complex,
and makes it challenging to optimize the consensus for both throughput and
confirmation latency while maintaining security.

In protocol 6 a new consensus protocol Concordium Byzantine Fault Tolerance
(BFT) will be used instead. The protocol offers high transaction throughput
and lower confirmation time because a block can be produced as soon as the
previous block has been certified. The overall architecture remains the same.
There are still bakers and a subset of them, the finalizers. In contrast to
how time was split into slots in existing consensus, Concordium BFT no
longer has a notion of slots. Instead it advances by rounds. In each round,
a predetermined leader among the bakers should produce a block. The members
of the finalization committee then sign this block, and their collective
signatures are aggregated to form a quorum certificate (QC). This quorum
certificate is then included in the next block. If the leader fails to
produce a block in the round, or not enough signatures were gathered for a
QC, then the finalizers will instead send timeout messages, which are
aggregated to form a timeout certificate. Each block always contains a
quorum certificate and may contain a timeout certificate for the previous
round if and only if the previous round timed out. When blocks on a common
chain in two consecutive rounds have quorum certificates, the block in the
first of these rounds (together with its ancestors) is considered
finalized. At this point, the protocol ensures that it cannot be rolled back.

Regarding smart contracts, the main usability improvement is better
support for sponsored transactions. Account's public keys are now
exposed to smart contracts, so signatures by sponsorees can be verified
without first registering public keys. Other improvements to smart
contracts are compatibility with recent Wasm changes, and revision of
execution costs to better reflect the actual costs involved in
execution.
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../CIS/cis-0.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">CIS-0: Standard Detection</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="P5.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Protocol Update 5 - Smart contract upgradability, performance improvements</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, Concordium |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>. |
            <a class="muted-link" href="../_sources/updates/P6.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Protocol Update 6 - Concordium BFT consensus protocol, changes in Wasm validation and execution</a><ul>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#commentary">Commentary</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/main.js"></script>
    </body>
</html>